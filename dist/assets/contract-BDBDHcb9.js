import{P as e,K as n,g as o,U as s,_ as a,T as t,S as r,a as i,b as l,c,d as g,e as d}from"./index-96YR-4iH.js";import"./ui-C_ecRgbg.js";import"./vendor-BoDUibaF.js";async function u(n,o){const[a]=e.findProgramAddressSync([d.ADMIN],c),[t]=e.findProgramAddressSync([d.CHALLENGE,n.toBuffer(),o.toBuffer()],c),[r]=e.findProgramAddressSync([d.ESCROW_WALLET],c),[i]=e.findProgramAddressSync([d.ESCROW_WALLET,t.toBuffer(),s.toBuffer()],c);return{adminStatePDA:a,challengePDA:t,escrowWalletPDA:r,escrowTokenAccountPDA:i}}async function f(d,f,h){if(console.log("üöÄ Creating challenge on smart contract..."),console.log(`Entry fee: ${h} USDFG`),!d||!d.publicKey)throw new Error("Wallet not connected");if(console.log(`‚úÖ Wallet connected: ${d.publicKey.toString()}`),h<1e-9||h>1e3)throw new Error("Entry fee must be between 0.000000001 and 1000 USDFG");if(console.log(`‚úÖ Entry fee valid: ${h} USDFG`),!d.signTransaction)throw new Error("Wallet does not support transaction signing");console.log("‚úÖ Wallet has signTransaction method"),console.log("‚úÖ Smart contract ready for player-consensus challenges"),console.log("üöÄ Creating challenge with USDFG amounts..."),console.log("üîß Step 1: Preparing transaction (bypassing Anchor)...");const y=new e(d.publicKey.toString());console.log(`üë§ Creator: ${y.toString()}`),console.log("üîß Step 2: Generating challenge seed...");const p=n.generate();console.log(`üîë Challenge seed: ${p.publicKey.toString()}`),console.log("üîß Step 3: Deriving PDAs...");const w=await u(y,p.publicKey);console.log(`üìç Challenge PDA: ${w.challengePDA.toString()}`),console.log("üîß Step 4: Getting token account...");const b=await o(s,y);console.log(`üí≥ Token account: ${b.toString()}`),console.log("üí∞ Entry fee (raw USDFG):",h);const S=Math.floor(h*Math.pow(10,9));console.log("üí∞ Entry fee in lamports:",S);const{sha256:m}=await a(async()=>{const{sha256:e}=await import("./sha2-DynuV8lm.js");return{sha256:e}},[]),W=m((new TextEncoder).encode("global:create_challenge")),k=Buffer.from(W.slice(0,8)),A=Buffer.alloc(16);k.copy(A,0);(function(e){const n=Buffer.allocUnsafe(8),o=BigInt(Math.floor(e));for(let s=0;s<8;s++)n[s]=Number(o>>BigInt(8*s)&BigInt(255));return n})(S).copy(A,8),console.log("üì¶ Instruction data created","Discriminator:",k.toString("hex")),console.log("‚úÖ Creating instruction with NEW smart contract (oracle-free)..."),console.log("üìç Escrow Token Account PDA:",w.escrowTokenAccountPDA.toString()),console.log("üìç Challenge PDA:",w.challengePDA.toString()),console.log("üìç Escrow Wallet PDA:",w.escrowWalletPDA.toString());const T=new t({programId:c,keys:[{pubkey:w.challengePDA,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:w.escrowTokenAccountPDA,isSigner:!1,isWritable:!0},{pubkey:w.escrowWalletPDA,isSigner:!1,isWritable:!1},{pubkey:p.publicKey,isSigner:!0,isWritable:!1},{pubkey:r.programId,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1}],data:A});console.log("‚úÖ Instruction created"),console.log("üîß Signing transaction...");const P=(new g).add(T),{blockhash:E}=await f.getLatestBlockhash();P.recentBlockhash=E,P.feePayer=y,console.log("üöÄ Sending transaction..."),P.partialSign(p);const D=await d.signTransaction(P);let B;try{B=await f.sendRawTransaction(D.serialize(),{skipPreflight:!1,maxRetries:0}),console.log("‚úÖ Transaction sent:",B)}catch(C){if(C.message?.includes("This transaction has already been processed")||C.message?.includes("already been processed"))return console.log("‚úÖ Transaction already processed - challenge likely created successfully"),console.log(`üìç Challenge PDA: ${w.challengePDA.toString()}`),w.challengePDA.toString();throw C}console.log("‚è≥ Confirming transaction...");try{await f.confirmTransaction(B,"confirmed")}catch(_){if(console.log("‚ö†Ô∏è  Confirmation warning:",_.message),!_.message?.includes("Transaction was not confirmed")&&!_.message?.includes("already been processed")&&!_.message?.includes("This transaction has already been processed"))throw _;console.log("‚úÖ Transaction likely succeeded despite confirmation error")}return console.log("‚úÖ Challenge created successfully!"),console.log(`üìç Challenge PDA: ${w.challengePDA.toString()}`),console.log(`üîó Transaction: https://explorer.solana.com/tx/${B}?cluster=devnet`),w.challengePDA.toString()}async function h(n,r,l){if(console.log("üéØ Accepting challenge..."),!n||!n.publicKey)throw new Error("Wallet not connected");const u=new e(n.publicKey.toString()),f=new e(l),h=await o(s,u),[y]=e.findProgramAddressSync([d.ESCROW_WALLET],c),[p]=e.findProgramAddressSync([d.ESCROW_WALLET,f.toBuffer(),s.toBuffer()],c),{sha256:w}=await a(async()=>{const{sha256:e}=await import("./sha2-DynuV8lm.js");return{sha256:e}},[]),b=w((new TextEncoder).encode("global:accept_challenge")),S=Buffer.from(b.slice(0,8)),m=Buffer.alloc(8);S.copy(m,0);const W=new t({programId:c,keys:[{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!0,isWritable:!0},{pubkey:h,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1}],data:m}),k=(new g).add(W),{blockhash:A}=await r.getLatestBlockhash();k.recentBlockhash=A,k.feePayer=u;const T=await n.signTransaction(k),P=await r.sendRawTransaction(T.serialize());return await r.confirmTransaction(P),console.log("‚úÖ Challenge accepted successfully!"),P}async function y(n,r,l,u){if(console.log("üèÜ Resolving challenge and triggering payout..."),console.log("   Challenge PDA:",l),console.log("   Winner:",u),!n||!n.publicKey)throw new Error("‚ùå Wallet not connected");let f;try{f=new e(u)}catch{throw new Error("‚ùå Invalid winner address")}const h=new e(n.publicKey.toString()),y=new e(l);console.log("‚úÖ Caller wallet verified:",h.toString());const p=new e("AcEV5t9TJdZP91ttbgKieWoWUxwUb4PT4MxvggDjjkkq");console.log("üìç Platform wallet:",p.toString());const[w]=e.findProgramAddressSync([d.ESCROW_WALLET],c),[b]=e.findProgramAddressSync([d.ESCROW_WALLET,y.toBuffer(),s.toBuffer()],c),S=await o(s,f),m=await o(s,p);console.log("üìç Derived accounts:"),console.log("   Platform Wallet:",p.toString()),console.log("   Escrow Wallet PDA:",w.toString()),console.log("   Escrow Token Account:",b.toString()),console.log("   Winner Token Account:",S.toString()),console.log("   Platform Token Account:",m.toString());const{sha256:W}=await a(async()=>{const{sha256:e}=await import("./sha2-DynuV8lm.js");return{sha256:e}},[]),k=W((new TextEncoder).encode("global:resolve_challenge")),A=Buffer.from(k.slice(0,8)),T=Buffer.alloc(72);A.copy(T,0),f.toBuffer().copy(T,8),h.toBuffer().copy(T,40),console.log("üì¶ Instruction data created"),console.log("   Discriminator:",A.toString("hex"));const P=new t({programId:c,keys:[{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1}],data:T});console.log("‚úÖ Instruction created with",P.keys.length,"accounts");const E=(new g).add(P),{blockhash:D}=await r.getLatestBlockhash();E.recentBlockhash=D,E.feePayer=h,console.log("üîß Signing transaction with caller wallet...");const B=await n.signTransaction(E);let C;console.log("üöÄ Sending transaction...");try{C=await r.sendRawTransaction(B.serialize(),{skipPreflight:!1,maxRetries:0}),console.log("‚úÖ Transaction sent:",C)}catch(_){if(_.message?.includes("This transaction has already been processed")||_.message?.includes("already been processed"))return console.log("‚úÖ Transaction already processed - prize likely claimed successfully"),console.log("üí∞ Winner received payout:",u),"already-processed";throw _}console.log("‚è≥ Confirming transaction...");try{await r.confirmTransaction(C,"confirmed")}catch(L){if(console.log("‚ö†Ô∏è  Confirmation warning:",L.message),!L.message?.includes("Transaction was not confirmed")&&!L.message?.includes("already been processed")&&!L.message?.includes("This transaction has already been processed"))throw L;console.log("‚úÖ Transaction likely succeeded despite confirmation error")}return console.log("‚úÖ Challenge resolved! Winner paid out!"),console.log("üîó Transaction:",`https://explorer.solana.com/tx/${C}?cluster=devnet`),console.log("üí∞ Winner received payout:",u),C}export{h as acceptChallenge,f as createChallenge,u as derivePDAs,y as resolveChallenge};
