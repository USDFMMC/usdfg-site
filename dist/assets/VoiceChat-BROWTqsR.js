const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-96YR-4iH.js","assets/ui-C_ecRgbg.js","assets/vendor-BoDUibaF.js","assets/index-arAt0ReB.css"])))=>i.map(i=>d[i]);
import{f as e,h as t,i as n,q as o,w as r,o as s,j as a,k as c,s as i,l,m as d,_ as g}from"./index-96YR-4iH.js";import{j as m}from"./ui-C_ecRgbg.js";import{r as u}from"./vendor-BoDUibaF.js";
/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const h=e("maximize-2",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]]),f=e("mic-off",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]),p=e("mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]),x=e("minimize-2",[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]]),y=({challengeId:e,currentWallet:l})=>{const[d,g]=u.useState([]),[h,f]=u.useState(""),[p,x]=u.useState(!1),y=u.useRef(null);u.useEffect(()=>{y.current?.scrollIntoView({behavior:"smooth"})},[d]),u.useEffect(()=>{if(!e||""===e.trim())return console.log("üì® ChatBox skipped - invalid challengeId:",e),void g([]);const a=t(n,"challenge_chats"),c=o(a,r("challengeId","==",e)),i=s(c,e=>{console.log("üì® Received messages:",e.size);const t=[];e.forEach(e=>{const n=e.data();console.log("üí¨ Message:",n),t.push({id:e.id,...n})}),t.sort((e,t)=>(e.timestamp?.seconds||0)-(t.timestamp?.seconds||0)),console.log("‚úÖ Messages sorted and ready:",t.length);const n=t.filter(e=>"SYSTEM"===e.sender);console.log("üü° System messages found:",n.length,n),g(t)},e=>{console.error("‚ùå Chat listener error:",e),console.error("Error code:",e.code),console.error("Error message:",e.message)});return()=>i()},[e]);const b=async()=>{if(h.trim()&&!p){x(!0);try{console.log("üì§ Sending message:",{challengeId:e,text:h.trim(),sender:l}),await c(t(n,"challenge_chats"),{challengeId:e,text:h.trim(),sender:l,timestamp:i()}),console.log("‚úÖ Message sent successfully"),f("")}catch(o){console.error("‚ùå Failed to send message:",o),alert("Failed to send message. Check console for details.")}finally{x(!1)}}};return m.jsxs("div",{className:"flex flex-col bg-black/30 rounded-xl p-3 h-48 border border-gray-700",children:[m.jsxs("div",{className:"flex items-center justify-between mb-2",children:[m.jsx("p",{className:"text-xs font-semibold text-gray-400 uppercase",children:"Chat"}),m.jsxs("span",{className:"text-xs text-gray-500",children:[d.length," messages"]})]}),m.jsxs("div",{className:"flex-1 overflow-y-auto space-y-2 mb-2 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent",children:[0===d.length?m.jsx("p",{className:"text-gray-500 text-xs text-center py-4",children:"No messages yet. Start the conversation!"}):d.map(e=>{const t=e.sender===l;return"SYSTEM"===e.sender?m.jsx("div",{className:"flex justify-center my-2",children:m.jsx("div",{className:"max-w-[90%] px-4 py-2 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-xs text-yellow-300 text-center",children:e.text})},e.id):m.jsx("div",{className:"flex "+(t?"justify-end":"justify-start"),children:m.jsxs("div",{className:"max-w-[80%] px-3 py-1.5 rounded-lg text-sm "+(t?"bg-gradient-to-r from-amber-600 to-amber-700 text-white":"bg-gray-800 text-gray-200"),children:[!t&&m.jsxs("p",{className:"text-xs text-gray-400 mb-0.5",children:[e.sender.slice(0,6),"..."]}),m.jsx("p",{className:"break-words",children:e.text})]})},e.id)}),m.jsx("div",{ref:y})]}),m.jsxs("div",{className:"flex items-center gap-2",children:[m.jsx("input",{className:"flex-1 bg-gray-800 text-white text-sm px-3 py-2 rounded-lg border border-gray-700 focus:border-amber-500 focus:outline-none placeholder-gray-500",placeholder:"Type message...",value:h,onChange:e=>f(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),b())},disabled:p}),m.jsx("button",{onClick:b,disabled:!h.trim()||p,className:"bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 disabled:opacity-50 disabled:cursor-not-allowed text-white p-2 rounded-lg transition-all",children:m.jsx(a,{className:"w-4 h-4"})})]})]})},b=({challengeId:e,currentWallet:t})=>{const[o,r]=u.useState(!1),[a,c]=u.useState(!1),[i,h]=u.useState(!1),[x,y]=u.useState("Initializing..."),[b,v]=u.useState(!1),w=u.useRef(null),j=u.useRef(null),k=u.useRef(null),C=u.useRef(0),E=u.useRef(null);console.log("üé§ VoiceChat component mounted",{challengeId:e,currentWallet:t}),u.useEffect(()=>{if(!b&&e&&""!==e.trim())return console.log("üé§ VoiceChat useEffect triggered - initializing..."),N(),()=>{console.log("üé§ VoiceChat useEffect cleanup"),S()};console.log("üé§ VoiceChat skipped - voice disabled or invalid challengeId:",e)},[e,t,b]),u.useEffect(()=>{const e=()=>{document.hidden?console.log("üì± Page hidden - preserving audio connection"):(console.log("üì± Page visible - resuming audio if needed"),k.current&&k.current.play().catch(e=>{console.log("Audio resume failed (may need user interaction):",e)}))};document.addEventListener("visibilitychange",e);const t=()=>{console.log("üì± Page blurred - keeping audio active")},n=()=>{console.log("üì± Page focused - ensuring audio is active"),k.current&&k.current.play().catch(e=>{console.log("Audio resume on focus failed:",e)})};return window.addEventListener("blur",t),window.addEventListener("focus",n),()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("blur",t),window.removeEventListener("focus",n)}},[]);const N=async()=>{if(!e||""===e.trim())return console.error("‚ùå Invalid challengeId for voice chat:",e),y("Error: Invalid challenge ID"),void c(!1);console.log("üé§ Starting voice chat initialization...");try{y("Requesting mic permission..."),console.log("üé§ Requesting microphone permission...");const o=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("‚úÖ Microphone permission granted!"),w.current=o,c(!0),y("Mic ready, waiting for opponent...");const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:openrelay.metered.ca:80","turn:openrelay.metered.ca:443","turn:openrelay.metered.ca:443?transport=tcp"],username:"openrelayproject",credential:"openrelayproject"}],iceCandidatePoolSize:10});j.current=r,o.getTracks().forEach(e=>{r.addTrack(e,o)}),r.ontrack=e=>{k.current&&e.streams[0]&&(k.current.srcObject=e.streams[0],k.current.play().catch(e=>console.error("Audio play failed:",e)),h(!0))};r.onicecandidate=async o=>{if(o.candidate){console.log("üßä New ICE candidate:",o.candidate.type);const r=`candidate_${t}_${Date.now()}`;await l(d(n,"voice_signals",e),{[r]:o.candidate.toJSON(),timestamp:Date.now()},{merge:!0})}else console.log("üßä All ICE candidates sent")},r.onconnectionstatechange=()=>{console.log("üîå Connection state:",r.connectionState),"connected"===r.connectionState?(h(!0),y("Voice connected!"),C.current=0,console.log("‚úÖ Voice chat connected!")):"connecting"===r.connectionState?y("Connecting to opponent..."):"disconnected"===r.connectionState?(h(!1),y("Disconnected, reconnecting..."),console.log("‚ö†Ô∏è Voice chat disconnected - attempting reconnect")):"failed"===r.connectionState&&(h(!1),C.current<3?(C.current++,y(`Connection failed, retry ${C.current}/3...`),console.log(`‚ùå Voice chat connection failed - retry attempt ${C.current}`),r.restartIce()):(y("Connection failed (check network)"),console.error("‚ùå Voice chat connection failed after max retries")))},r.oniceconnectionstatechange=()=>{console.log("üßä ICE connection state:",r.iceConnectionState),"connected"===r.iceConnectionState||"completed"===r.iceConnectionState?console.log("‚úÖ ICE connection established!"):"failed"===r.iceConnectionState&&console.error("‚ùå ICE connection failed - may need better TURN servers")};const a=d(n,"voice_signals",e),i=s(a,async n=>{if(!e||""===e.trim())return void console.log("‚ö†Ô∏è challengeId became invalid during snapshot, ignoring");const o=n.data();if(o)try{if(o.offer&&o.offerFrom!==t&&!r.currentRemoteDescription){console.log("üìû Received offer, creating answer..."),await r.setRemoteDescription(new RTCSessionDescription(o.offer));const e=await r.createAnswer();await r.setLocalDescription(e),await l(a,{answer:e,answerFrom:t,timestamp:Date.now()},{merge:!0})}else o.answer&&o.answerFrom!==t&&o.offerFrom===t&&("have-local-offer"!==r.signalingState||r.currentRemoteDescription||(console.log("‚úÖ Received answer, setting remote description..."),await r.setRemoteDescription(new RTCSessionDescription(o.answer))));Object.keys(o).forEach(async e=>{if(e.startsWith("candidate_")&&!e.includes(t))try{r.remoteDescription?(console.log("üßä Adding remote ICE candidate"),await r.addIceCandidate(new RTCIceCandidate(o[e]))):console.log("‚è≥ Queuing ICE candidate (no remote description yet)")}catch(n){console.error("‚ùå Failed to add ICE candidate:",n)}})}catch(s){console.error("‚ùå Error handling WebRTC signal:",s)}},e=>{"invalid-argument"===e.code||e.message.includes("segments")?(console.error("‚ùå Invalid Firestore path - challengeId may be empty:",e),y("Error: Invalid challenge ID"),c(!1)):console.error("‚ùå Firestore snapshot error:",e)});E.current=i,await new Promise(e=>setTimeout(e,100));const{getDoc:m}=await g(async()=>{const{getDoc:e}=await import("./index-96YR-4iH.js").then(e=>e.y);return{getDoc:e}},__vite__mapDeps([0,1,2,3])),u=(await m(a)).data();if(u?.offer)u.offerFrom!==t&&(console.log("üìû Offer already exists from opponent, will answer when ready"),y("Found opponent, connecting..."));else{console.log("üìû Creating offer (first person in room)..."),y("Creating offer, waiting for opponent...");const e=await r.createOffer();await r.setLocalDescription(e),await l(a,{offer:e,offerFrom:t,timestamp:Date.now()},{merge:!0})}}catch(o){console.error("‚ùå Voice chat init failed:",o),c(!1);let e="Unknown error";o instanceof Error&&(e="NotAllowedError"===o.name||o.message.includes("Permission denied")?"Mic permission denied. Please allow mic access.":o.message.includes("AVAudioSession")||o.message.includes("NotReadableError")?"Mic in use by another app. Close other apps.":"NotFoundError"===o.name?"No microphone found":o.message),y(`Error: ${e}`)}},S=async()=>{if(console.log("üßπ Cleaning up voice chat..."),E.current&&(E.current(),E.current=null,console.log("‚úÖ Unsubscribed from Firestore signals")),e&&""!==e.trim())try{const{deleteDoc:t,doc:o}=await g(async()=>{const{deleteDoc:e,doc:t}=await import("./index-96YR-4iH.js").then(e=>e.y);return{deleteDoc:e,doc:t}},__vite__mapDeps([0,1,2,3]));await t(o(n,"voice_signals",e)),console.log("‚úÖ Cleaned up Firestore signals document")}catch(t){"not-found"===t.code||t.message?.includes("not found")||console.log("‚ö†Ô∏è Could not delete Firestore signals document (may already be cleaned up):",t)}w.current&&(w.current.getTracks().forEach(e=>{e.stop(),console.log("üõë Stopped track:",e.kind)}),w.current=null),j.current&&(j.current.close(),j.current=null),c(!1),h(!1),r(!1),y("")};return b?m.jsx("div",{className:"p-3 rounded-lg border border-gray-700 bg-gray-800/50",children:m.jsxs("div",{className:"flex justify-between items-center",children:[m.jsxs("div",{className:"flex items-center gap-2",children:[m.jsx("div",{className:"w-2 h-2 rounded-full bg-gray-500"}),m.jsx("span",{className:"text-gray-400 text-sm",children:"Voice chat disabled (using text only)"})]}),m.jsx("button",{onClick:()=>{v(!1),y("Initializing...")},className:"px-3 py-1 rounded-lg bg-gray-700 hover:bg-gray-600 text-white text-xs transition-colors",children:"Enable Voice"})]})}):m.jsxs("div",{className:"p-3 rounded-lg border "+(x.includes("Error")||x.includes("use by another")?"bg-red-900/20 border-red-500/30":"bg-gray-800 border-gray-700"),children:[m.jsx("audio",{ref:k,autoPlay:!0}),m.jsxs("div",{className:"flex justify-between items-center",children:[m.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[m.jsx("div",{className:"w-2 h-2 rounded-full flex-shrink-0 "+(i?"bg-green-500 animate-pulse":a?"bg-yellow-500":"bg-red-500")}),m.jsxs("div",{className:"flex flex-col flex-1 min-w-0",children:[m.jsx("span",{className:"text-white text-sm font-medium",children:i?"üéôÔ∏è Voice Connected":a?"üîå Voice Chat":"‚ùå Voice Unavailable"}),m.jsx("span",{className:"text-xs truncate "+(x.includes("Error")?"text-red-400":"text-gray-400"),children:x}),x.includes("Error")&&m.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[m.jsx("span",{className:"text-xs text-gray-500",children:"üí¨ Text chat works fine"}),m.jsx("button",{onClick:()=>{S(),v(!0)},className:"text-xs text-blue-400 hover:text-blue-300 underline",children:"Skip voice"})]})]})]}),m.jsx("button",{onClick:()=>{if(!w.current)return;const e=!o;w.current.getAudioTracks().forEach(t=>{t.enabled=!e}),r(e)},disabled:!a,className:"px-3 py-2 rounded-lg text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 "+(o?"bg-red-600 hover:bg-red-700 shadow-[0_0_15px_rgba(239,68,68,0.2)]":"bg-green-600 hover:bg-green-700 shadow-[0_0_15px_rgba(16,185,129,0.2)]"),children:o?m.jsx(f,{className:"w-4 h-4"}):m.jsx(p,{className:"w-4 h-4"})})]})]})};export{y as C,h as M,b as V,x as a};
